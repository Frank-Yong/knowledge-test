# OperatingContextMcp Session Log

- Timestamp: 2026-02-28 11:00:08 (UTC)
- Source repo: operating-context-mcp
- Branch: phase-2-mcp-handshake
- Trigger: reviewer malformed-header buffering comment + `log it`

## Change implemented

### Read buffer resynchronization on invalid/missing Content-Length
- File: `src/OperatingContextMcp.Server/Worker.cs`
- In `ReadMessageAsync`, for `contentLength <= 0`:
  - changed from `readBuffer.RemoveRange(0, headerLength)`
  - to `readBuffer.Clear()`
- Exception behavior remains the same (`InvalidOperationException`), but buffered trailing bytes from malformed frames are now discarded to prevent parser desynchronization on the next frame.

## Why this matters
- Buffered reads can include bytes past the header terminator.
- If header is invalid, keeping trailing bytes can poison subsequent header parsing.
- Clearing buffer is a safe resync strategy for malformed frame recovery.

## Validation
- Command: `dotnet test tests/OperatingContextMcp.Tests.Unit/OperatingContextMcp.Tests.Unit.csproj`
- Result: passed (`27` total, `0` failed).

## Status snapshot
- Review comment about invalid-header leftover bytes causing potential parse desync is addressed.
