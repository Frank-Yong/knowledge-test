# OperatingContextMcp Session Log

- Timestamp: 2026-02-26 05:06:00 (local)
- Source repo: operating-context-mcp
- Branch: phase-2-mcp-handshake
- Trigger: reviewer performance comment + `log it`

## Change implemented

### `ReadMessageAsync` header parsing optimization
- File: `src/OperatingContextMcp.Server/Worker.cs`
- Replaced one-byte-at-a-time header reads with buffered chunk reads (`ReadChunkBytes = 4096`) and terminator scanning for `\r\n\r\n`.
- Wrapped stdin with `BufferedStream` in `ExecuteAsync` and introduced a persistent `readBuffer` to retain carryover bytes between frames.
- Added `IndexOfHeaderTerminator(List<byte>)` helper for header boundary detection.
- Updated payload assembly to consume exactly one frame and leave extra bytes buffered for the next read.
- Preserved existing frame caps (`MaxHeaderBytes`, `MaxContentBytes`, `MaxOversizeDiscardBytes`) and fatal/invalid protocol behavior.
- Improved `DiscardUntilHeaderTerminatorAsync` to scan in chunks instead of one-byte reads (still only used on invalid oversize-header recovery path).

## Why this matters
- Reduces stdio overhead from many tiny async reads per frame.
- Keeps protocol correctness when reads include bytes from subsequent frames by buffering and consuming precisely.
- Maintains existing safety limits and error semantics.

## Validation
- Command: `dotnet build src/OperatingContextMcp.sln`
- Result: succeeded.
- File diagnostics for `Worker.cs`: no errors found.

## Status snapshot
- This addresses the reviewer note on read-path performance/readability for MCP frame parsing.
